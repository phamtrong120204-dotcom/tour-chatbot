<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ph·∫°m Tr·ªçng ‚Äì T∆∞ v·∫•n Tour</title>

<style>
*{
  box-sizing:border-box;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
}
html,body{
  height:100%;
  margin:0;
  background:#f3f4f6;
  overflow:hidden;
}

/* ===== APP ===== */
.wrap{
  position:fixed;
  inset:0;
  max-width:520px;
  margin:0 auto;
  background:#fff;
  display:flex;
  flex-direction:column;
}

/* ===== HEADER ===== */
.top{
  padding:14px 16px;
  border-bottom:1px solid #eee;
}
.brand{font-weight:700}
.sub{font-size:13px;color:#555;margin-top:4px}

/* ===== CHAT ===== */
.chat{
  flex:1;
  overflow-y:auto;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:10px;
  background:#fafafa;
}
.msg{
  max-width:85%;
  padding:10px 12px;
  border-radius:14px;
  line-height:1.4;
  word-break:break-word;
}
.msg.bot{
  background:#eef2f7;
  align-self:flex-start;
}
.msg.me{
  background:#2563eb;
  color:#fff;
  align-self:flex-end;
}

/* ===== CONFIRM BUTTON ===== */
.confirm-btn{
  display:none;
  margin:8px 12px;
  padding:14px;
  border:none;
  border-radius:12px;
  background:#16a34a;
  color:#fff;
  font-weight:600;
  font-size:15px;
  cursor:pointer;
}

/* ===== INPUT ===== */
.bar{
  display:flex;
  gap:8px;
  padding:12px;
  border-top:1px solid #eee;
}
.bar input{
  flex:1;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid #ccc;
}
.bar button{
  padding:0 18px;
  border:none;
  border-radius:999px;
  background:#111;
  color:#fff;
  font-weight:600;
}

/* ===== FOOTER ===== */
.foot{
  padding:6px;
  font-size:11px;
  color:#666;
  text-align:center;
}
  .input-note{
  text-align:center;
  font-size:12px;
  color:#6b7280;
  margin:4px 12px 6px;
}
</style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="brand">Ph·∫°m Tr·ªçng ‚Äì T∆∞ v·∫•n Tour</div>
    <div class="sub">H·ªó tr·ª£ tour, l·ªãch tr√¨nh & gi√° minh b·∫°ch</div>
  </div>

  <div id="chat" class="chat"></div>

  <!-- ‚úÖ N√öT X√ÅC NH·∫¨N (CH·ªà 1 C√ÅI) -->
  <button id="confirmBtn" class="confirm-btn">
    ‚úÖ X√ÅC NH·∫¨N ƒê·∫∂T TOUR
  </button>

  <form id="form" class="bar">
  <input id="input" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." autocomplete="off">
  <button>G·ª≠i</button>
</form>

<!-- üîπ M√¥ t·∫£ nh·ªè -->
<div class="input-note">
  üí¨ ƒê√¢y l√† BOTCHAT t·ª± ƒë·ªông, n·∫øu x√°c nh·∫≠n ƒë·∫∑t tour Anh/Ch·ªã vui l√≤ng ƒë·ªÉ l·∫°i th√¥ng tin ·ªü m·ª•c li√™n h·ªá
</div>

<div class="foot">Ho·∫°t ƒë·ªông 24/7 ‚Ä¢ T∆∞ v·∫•n t·ª± ƒë·ªông</div>

<script>
/* ===== CONFIG ===== */
const API_URL   = "https://tour-chatbot-api.vercel.app/api/chat";
const SHEET_API = "https://script.google.com/macros/s/AKfycbzL_4H4O08AFj7Leh9S5sevRlPNe0JgDABpLVo709R55VGQ_gNA6LiVEoC7uJZ/exec";

/* ===== DOM ===== */
const chat = document.getElementById("chat");
const form = document.getElementById("form");
const input = document.getElementById("input");
const confirmBtn = document.getElementById("confirmBtn");

/* ===== STATE ===== */
let conversation = [];
let customerDate = "";
let customerPeople = "";
let customerPhone = "";
let customerEmail = "";

/* ===== SCROLL ===== */
function scrollBottom(){
  requestAnimationFrame(()=>{
    chat.scrollTop = chat.scrollHeight;
  });
}

/* ===== ADD MESSAGE ===== */
function addMsg(text,type){
  const div = document.createElement("div");
  div.className = "msg " + (type==="user" ? "me" : "bot");
  div.textContent = text;
  chat.appendChild(div);
  scrollBottom();

  conversation.push({
    role: type==="user" ? "user" : "assistant",
    content: text
  });
}

/* ===== SAVE LEAD ===== */
async function saveLead(note){
  const payload = {
    name: "Kh√°ch website",
    phone: customerPhone,
    email: customerEmail,
    date: customerDate,
    people: customerPeople,
    message: note
  };
  await fetch(SHEET_API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });
}

/* ===== CHECK CONFIRM ===== */
function canConfirm(){
  return customerDate && customerPeople && customerPhone;
}

/* ===== WELCOME ===== */
addMsg(
  "Xin ch√†o üëã M√¨nh l√† Ph·∫°m Tr·ªçng. Anh/ch·ªã cho m√¨nh bi·∫øt ng√†y ƒëi & s·ªë ng∆∞·ªùi ƒë·ªÉ m√¨nh t∆∞ v·∫•n ch√≠nh x√°c nh√©.",
  "bot"
);

/* ===== SUBMIT ===== */
form.addEventListener("submit", async e=>{
  e.preventDefault();
  const msg = input.value.trim();
  if(!msg) return;

  addMsg(msg,"user");
  input.value="";

  if(/\d{1,2}[\/\-]\d{1,2}/.test(msg)) customerDate = msg;
  if(/ng∆∞·ªùi/i.test(msg)) customerPeople = msg;
  const phone = msg.match(/0\d{9,10}/);
  if(phone) customerPhone = phone[0];
  const email = msg.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-z]{2,}/);
  if(email) customerEmail = email[0];

  if(canConfirm()) confirmBtn.style.display="block";

  const res = await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ message:msg, history:conversation })
  });
  const data = await res.json();
  addMsg(data.reply || "M√¨nh ki·ªÉm tra ngay cho anh/ch·ªã nh√©.","bot");
});

/* ===== CONFIRM CLICK ===== */
confirmBtn.onclick = async ()=>{
  await saveLead("Kh√°ch b·∫•m x√°c nh·∫≠n ƒë·∫∑t tour");
  addMsg(
    "üéâ M√¨nh ƒë√£ gi·ªØ ch·ªó cho anh/ch·ªã. B√™n m√¨nh s·∫Ω li√™n h·ªá x√°c nh·∫≠n chi ti·∫øt trong √≠t ph√∫t nh√©!",
    "bot"
  );
  confirmBtn.style.display="none";
};
</script>
</body>
</html>
